<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNC Stage Map — Star Mountain Capital</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#1a2b4a;--gold:#c9a84c;--gold-dim:#f5edd8;--gold-text:#7a5e1a;
  --white:#ffffff;--bg:#f9f8f6;--rule:#e2ddd5;--rule-lt:#ede9e2;
  --text:#1a2b4a;--text-mid:#4a5568;--text-dim:#8a96a8;
  --green:#2e6b4f;
  --c0:#cdd5de;--c1:#8fa8c0;--c2:#5a82a0;--c3:#c9a84c;--c4:#2e6b4f;--c5:#1a2b4a;
}
body{background:var(--white);font-family:'Inter',sans-serif;color:var(--text);-webkit-font-smoothing:antialiased;font-size:14px}
.page{max-width:1380px;margin:0 auto;padding:36px 48px 96px}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding-bottom:20px;border-bottom:2.5px solid var(--navy);gap:20px}
.header-left{display:flex;align-items:center;gap:16px}
.header-logo{flex-shrink:0;width:46px;height:46px}
.header-text h1{font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-0.02em;line-height:1.2}
.header-text .sub{font-size:11px;font-weight:400;color:var(--text-dim);letter-spacing:0.09em;text-transform:uppercase;margin-top:3px}
.header-right{display:flex;align-items:center;gap:14px}
.header-date{font-size:11px;color:var(--text-dim);letter-spacing:0.07em;text-transform:uppercase}

/* SAVE BTN */
.save-btn{display:inline-flex;align-items:center;gap:8px;background:var(--navy);color:#fff;border:none;border-radius:5px;cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.04em;padding:10px 20px;transition:background .15s,transform .1s;white-space:nowrap}
.save-btn:hover{background:#253d68}
.save-btn:active{transform:scale(0.97)}
.save-btn.saved{background:var(--green)!important}

/* STAGE KEY */
.stage-key-bar{display:flex;align-items:stretch;border-bottom:1px solid var(--rule);background:var(--bg)}
.key-label{font-size:9px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--text-dim);padding:12px 18px;border-right:1px solid var(--rule);display:flex;align-items:center;white-space:nowrap;flex-shrink:0}
.key-stages{display:flex;flex:1}
.key-stage{flex:1;display:flex;align-items:center;gap:10px;padding:11px 14px;border-right:1px solid var(--rule)}
.key-stage:last-child{border-right:none}
.key-swatch{width:32px;height:7px;border-radius:3px;flex-shrink:0}
.key-text{line-height:1.35}
.key-num{font-size:11px;font-weight:700;color:var(--text);display:block}
.key-desc{font-size:9.5px;color:var(--text-dim);display:block;white-space:nowrap}

/* EDIT HINT */
.edit-hint{background:linear-gradient(135deg,#f5edd8 0%,#fdf9f2 100%);border:1px solid rgba(201,168,76,0.3);border-radius:5px;padding:10px 16px;margin-top:16px;display:flex;align-items:center;gap:10px;font-size:11.5px;color:var(--gold-text)}
.edit-hint svg{flex-shrink:0}

/* SECTION */
.section{margin-top:24px}
.section-head{display:flex;align-items:center;gap:12px;margin-bottom:9px}
.section-tag{font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;padding:4px 13px;border-radius:3px}
.section-tag.dollars{background:var(--gold);color:#fff}
.section-tag.deals{background:var(--navy);color:#fff}
.section-desc{font-size:12px;font-style:italic;color:var(--text-dim)}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;border:1px solid var(--rule)}
.tbl thead tr{background:var(--navy)}
.tbl thead th{padding:9px 13px;font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.5);text-align:left;border-right:1px solid rgba(255,255,255,0.07);white-space:nowrap}
.tbl thead th:last-child{border-right:none}
.tbl thead th.th-center{text-align:center}
.tbl thead th.th-gold{color:rgba(201,168,76,0.95)}
.tbl tbody tr{border-bottom:1px solid var(--rule-lt)}
.tbl tbody tr:last-child{border-bottom:none}
.tbl tbody tr:nth-child(even) td{background:var(--bg)}
.tbl tbody tr:hover td{background:#f2ece0!important}
.tbl tbody tr.live-row td{background:rgba(46,107,79,0.05)!important}
.tbl tbody tr.live-row:hover td{background:#edf5ef!important}
.tbl td{padding:10px 13px;vertical-align:top;border-right:1px solid var(--rule-lt)}
.tbl td:last-child{border-right:none}
.tbl tr.live-row td:first-child{border-left:4px solid var(--green);padding-left:10px}

/* col widths */
.col-biz{width:185px}
.col-prod{width:175px}
.col-strat{width:145px}
.col-track{min-width:220px}
.col-notes{width:155px}
.col-actions{width:36px;text-align:center}

/* EDITABLE INPUT FIELDS */
.edit-field{font-family:'Inter',sans-serif;font-size:13px;font-weight:600;color:var(--navy);border:1px solid transparent;border-radius:3px;padding:2px 5px;margin:-2px -5px;background:transparent;width:100%;outline:none;transition:border-color .12s,background .12s;display:block}
.edit-field:hover{border-color:var(--rule);background:var(--bg)}
.edit-field:focus{border-color:var(--gold);background:#fffdf7;box-shadow:0 0 0 3px rgba(201,168,76,0.15)}
.edit-field.sub{font-size:11px;font-weight:400;color:var(--text-dim);margin-top:4px}
.edit-field.strat{font-size:11.5px;font-weight:400;color:var(--text-mid);font-style:italic}
.edit-field.badge{font-size:10px;font-weight:600;border-radius:3px;padding:2px 7px;margin-top:6px;width:auto;display:inline-block}
.badge-o{background:rgba(26,43,74,0.07);color:var(--navy)}
.badge-f{background:var(--gold-dim);color:var(--gold-text)}
.badge-c{background:#ede9e2;color:var(--text-dim)}

/* NOTES */
.notes-edit{font-size:11.5px;line-height:1.55;width:100%;min-height:32px;resize:none;overflow:hidden;border:1px solid transparent;border-radius:3px;padding:3px 5px;margin:-3px -5px;background:transparent;font-family:'Inter',sans-serif;outline:none;display:block;transition:border-color .12s,background .12s;color:var(--text-dim)}
.notes-edit:hover{border-color:var(--rule);background:var(--bg)}
.notes-edit:focus{border-color:var(--gold);background:#fffdf7;box-shadow:0 0 0 3px rgba(201,168,76,0.15);color:var(--text)}
.notes-edit.ph{color:var(--text-dim);font-style:italic;opacity:.55}

/* TRACK SVG */
.track-wrap{padding-top:2px}
.track-svg{
  display:block;width:100%;height:52px;cursor:pointer;
  border-radius:4px;transition:opacity .12s, box-shadow .12s;
}
.track-svg:hover{opacity:.88;box-shadow:0 0 0 2px var(--gold)}
/* ALL children get pointer-events:none so the SVG element itself is always the click target */
.track-svg *{pointer-events:none!important}

/* INLINE STAGE PICKER — expands inside the same cell, NO positioning math */
.inline-picker{
  display:none;
  margin-top:7px;
  background:#fff;
  border:1px solid var(--rule);
  border-radius:6px;
  padding:9px 8px 8px;
  box-shadow:0 4px 20px rgba(26,43,74,0.13);
}
.inline-picker.open{display:block}
.picker-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.picker-label{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim)}
.picker-close-btn{background:none;border:none;cursor:pointer;font-size:14px;color:var(--text-dim);padding:0 2px;line-height:1}
.picker-close-btn:hover{color:var(--navy)}
.stage-opts{display:grid;grid-template-columns:repeat(6,1fr);gap:4px}
.stage-opt{
  display:flex;flex-direction:column;align-items:center;
  padding:7px 3px;border-radius:4px;cursor:pointer;
  border:2px solid transparent;transition:all .1s;background:var(--bg);
  user-select:none;
}
.stage-opt:hover{border-color:var(--gold);background:var(--gold-dim)}
.stage-opt.active{border-color:var(--navy);background:rgba(26,43,74,0.06)}
.stage-num{font-size:16px;font-weight:700;line-height:1;margin-bottom:3px}
.stage-lbl{font-size:7px;text-align:center;line-height:1.3;color:var(--text-mid);font-weight:500}

/* ADD / DELETE ROW */
.add-row-btn{display:flex;align-items:center;gap:7px;margin-top:8px;background:none;border:1.5px dashed var(--rule);border-radius:5px;padding:7px 14px;font-size:11.5px;font-weight:600;color:var(--text-dim);cursor:pointer;transition:all .15s;width:100%}
.add-row-btn:hover{border-color:var(--gold);color:var(--gold-text);background:var(--gold-dim)}
.del-btn{background:none;border:none;cursor:pointer;color:var(--text-dim);opacity:0;transition:opacity .12s,color .12s;padding:3px;border-radius:3px;font-size:14px;line-height:1;margin-top:2px}
tr:hover .del-btn{opacity:1}
.del-btn:hover{color:#c0392b;background:#fdf0ee}

/* STICKY SAVE BAR */
.save-bar{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid var(--rule);padding:12px 48px;display:flex;align-items:center;justify-content:space-between;z-index:100;box-shadow:0 -4px 20px rgba(0,0,0,0.06)}
.save-bar-hint{font-size:11px;color:var(--text-dim)}
.save-bar-hint strong{color:var(--text-mid)}
.watermark{margin-top:16px;display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);padding-top:12px;border-top:1px solid var(--rule-lt)}
</style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <svg class="header-logo" viewBox="0 0 46 46" fill="none">
        <rect width="46" height="46" fill="#1a2b4a" rx="4"/>
        <polyline points="5,37 14,19 22,26 30,15 41,37" fill="none" stroke="#c9a84c" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>
        <polygon points="30,6.5 31.3,10.5 35.6,10.5 32.2,13.1 33.5,17.1 30,14.5 26.5,17.1 27.8,13.1 24.4,10.5 28.7,10.5" fill="#c9a84c"/>
      </svg>
      <div class="header-text">
        <h1>PNC × Star Mountain Capital &nbsp;·&nbsp; Stage Map</h1>
        <div class="sub">Callan Engagement Chart — Where Are We?</div>
      </div>
    </div>
    <div class="header-right">
      <span class="header-date">February 2026</span>
      <button class="save-btn" id="saveBtnTop" onclick="saveFile()">
        <svg width="13" height="13" viewBox="0 0 16 16" fill="none"><path d="M2 2h9l3 3v9a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1z" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="9" width="8" height="5" rx="0.5" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="2" width="5" height="3" rx="0.5" stroke="currentColor" stroke-width="1.5"/></svg>
        Save &amp; Download
      </button>
    </div>
  </div>

  <!-- STAGE KEY -->
  <div class="stage-key-bar">
    <div class="key-label">Stage Key</div>
    <div class="key-stages">
      <div class="key-stage"><div class="key-swatch" style="background:var(--c0)"></div><div class="key-text"><span class="key-num">Stage 0</span><span class="key-desc">Not yet engaged</span></div></div>
      <div class="key-stage"><div class="key-swatch" style="background:var(--c1)"></div><div class="key-text"><span class="key-num">Stage 1</span><span class="key-desc">First contact / intro</span></div></div>
      <div class="key-stage"><div class="key-swatch" style="background:var(--c2)"></div><div class="key-text"><span class="key-num">Stage 2</span><span class="key-desc">Active dialogue / diligence</span></div></div>
      <div class="key-stage"><div class="key-swatch" style="background:var(--c3)"></div><div class="key-text"><span class="key-num">Stage 3</span><span class="key-desc">Proposal / term sheet</span></div></div>
      <div class="key-stage"><div class="key-swatch" style="background:var(--c4)"></div><div class="key-text"><span class="key-num">Stage 4</span><span class="key-desc">Approved / pilot</span></div></div>
      <div class="key-stage"><div class="key-swatch" style="background:var(--c5)"></div><div class="key-text"><span class="key-num">Stage 5</span><span class="key-desc">Strategic partner / recurring</span></div></div>
    </div>
  </div>

  <!-- EDIT HINT -->
  <div class="edit-hint">
    <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M11.5 1.5l3 3L5 14H2v-3L11.5 1.5z" stroke="#7a5e1a" stroke-width="1.5" stroke-linejoin="round"/></svg>
    <span><strong>Click any text field</strong> to edit &nbsp;·&nbsp; <strong>Click a stage bar</strong> to expand stage selector inline &nbsp;·&nbsp; <strong>+ Add Row</strong> to add &nbsp;·&nbsp; hover + <strong>✕</strong> to remove &nbsp;·&nbsp; <strong>Save &amp; Download</strong> to keep changes</span>
  </div>

  <!-- DOLLARS -->
  <div class="section">
    <div class="section-head">
      <span class="section-tag dollars">$ &nbsp;Dollars</span>
      <span class="section-desc">Capital Syndication &amp; Fund Platform Channels</span>
    </div>
    <table class="tbl">
      <thead><tr>
        <th class="col-biz">Business Line</th>
        <th class="col-prod">Product / Badge</th>
        <th class="col-strat">Strategy / LOB</th>
        <th class="col-track th-center th-gold">Engagement Stage — click bar to change →</th>
        <th class="col-notes">Notes</th>
        <th class="col-actions"></th>
      </tr></thead>
      <tbody id="tbody-dollars"></tbody>
    </table>
    <button class="add-row-btn" onclick="addRow('dollars')">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="5" x2="8" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="5" y1="8" x2="11" y2="8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      Add Row to Dollars
    </button>
  </div>

  <!-- DEALS -->
  <div class="section">
    <div class="section-head">
      <span class="section-tag deals">⚡ Deals</span>
      <span class="section-desc">Deal Flow &amp; Co-Investment Channels</span>
    </div>
    <table class="tbl">
      <thead><tr>
        <th class="col-biz">Business Line</th>
        <th class="col-prod">Product / Badge</th>
        <th class="col-strat">Strategy / LOB</th>
        <th class="col-track th-center th-gold">Engagement Stage — click bar to change →</th>
        <th class="col-notes">Notes</th>
        <th class="col-actions"></th>
      </tr></thead>
      <tbody id="tbody-deals"></tbody>
    </table>
    <button class="add-row-btn" onclick="addRow('deals')">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="5" x2="8" y2="11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="5" y1="8" x2="11" y2="8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      Add Row to Deals
    </button>
  </div>

  <div class="watermark">
    <span>PNC × Star Mountain Capital — Callan Engagement Stage Map</span>
    <span>Private &amp; Confidential · Star Mountain Capital</span>
  </div>
</div>

<!-- STICKY SAVE BAR -->
<div class="save-bar">
  <div class="save-bar-hint"><strong>All fields editable.</strong> Click any stage bar to change progress inline. Save &amp; Download preserves all changes.</div>
  <button class="save-btn" id="saveBtnBar" onclick="saveFile()">
    <svg width="13" height="13" viewBox="0 0 16 16" fill="none"><path d="M2 2h9l3 3v9a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1z" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="9" width="8" height="5" rx="0.5" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="2" width="5" height="3" rx="0.5" stroke="currentColor" stroke-width="1.5"/></svg>
    Save &amp; Download
  </button>
</div>

<script>
// ── DATA ─────────────────────────────────────────────────────────────────────
let ROWS_DOLLARS = [
  {id:"pnc_cfv",    biz:"PNC Private Bank & Hawthorn",        bizSub:"UHNW / Multi-Family Office",       product:"Credit Fund V",                  badge:"● Open · Direct Lending",         badgeCls:"badge-o",strategy:"Syndicate capital through HNW & ultra-affluent client channels",stage:4,notes:""},
  {id:"pnc_cf3",    biz:"PNC Private Bank & Hawthorn",        bizSub:"UHNW / Multi-Family Office",       product:"Credit Fund III",                badge:"● Open · Direct Lending",         badgeCls:"badge-o",strategy:"Syndicate capital through HNW & ultra-affluent client channels",stage:5,notes:""},
  {id:"pnc_cf2",    biz:"PNC Private Bank & Hawthorn",        bizSub:"UHNW / Multi-Family Office",       product:"Credit Fund II",                 badge:"◆ Closed Fund",                   badgeCls:"badge-c",strategy:"Syndicate capital through HNW & ultra-affluent client channels",stage:5,notes:""},
  {id:"pnc_sec3",   biz:"PNC Private Bank & Hawthorn",        bizSub:"UHNW / Multi-Family Office",       product:"Secondary Fund III",             badge:"● Open · Secondaries",            badgeCls:"badge-o",strategy:"Syndicate capital through HNW & ultra-affluent client channels",stage:1,notes:""},
  {id:"pnc_agility",biz:"PNC Private Bank & Hawthorn",        bizSub:"UHNW / Multi-Family Office",       product:"Agility Fund",                   badge:"● Open · Secondaries (Evergreen)",badgeCls:"badge-o",strategy:"Syndicate capital through HNW & ultra-affluent client channels",stage:0,notes:""},
  {id:"pnc_idf",    biz:"PNC Private Bank & Hawthorn",        bizSub:"UHNW / Multi-Family Office",       product:"Insurance Dedicated Fund",       badge:"● Open · Fund of Funds",          badgeCls:"badge-o",strategy:"Syndicate capital through HNW & ultra-affluent client channels",stage:0,notes:"Hawthorn Business Owner practice — liquidity event planning"},
  {id:"iam_cfo",    biz:"PNC Institutional Asset Mgmt (IAM)", bizSub:"PNC Capital Advisors — SEC RIA",   product:"Collateralized Fund Obligation",  badge:"● Open · Direct Lending",         badgeCls:"badge-o",strategy:"Managed account & fund platform access via SEC-registered RIA", stage:0,notes:""},
  {id:"iam_epc",    biz:"PNC Institutional Asset Mgmt (IAM)", bizSub:"PNC Capital Advisors — SEC RIA",   product:"Evergreen Private Credit Fund",   badge:"● Open · Direct Lending",         badgeCls:"badge-o",strategy:"Managed account & fund platform access via SEC-registered RIA", stage:0,notes:""},
  {id:"iam_sma",    biz:"PNC Institutional Asset Mgmt (IAM)", bizSub:"PNC Capital Advisors — SEC RIA",   product:"Credit-Focused SMA",             badge:"◆ Future · Direct Lending",       badgeCls:"badge-f",strategy:"Managed account & fund platform access via SEC-registered RIA", stage:0,notes:""},
];
let ROWS_DEALS = [
  {id:"dcm_main",   biz:"PNC Capital Markets LLC",            bizSub:"Debt Capital Markets & Loan Synd.",product:"Direct Co-Investment Pipeline",   badge:"● Active Channel",                badgeCls:"badge-o",strategy:"Co-investment & direct lending from DCM origination pipeline",             stage:5,notes:"Top 5 middle-market syndicator — 5 consecutive years"},
  {id:"hw_ma",      biz:"Harris Williams & Co.",               bizSub:"M&A Advisory — PNC Subsidiary",    product:"M&A Deal Flow Pipeline",          badge:"● Active Channel",                badgeCls:"badge-o",strategy:"Proprietary deal flow — industrials, healthcare, tech & consumer",          stage:0,notes:""},
  {id:"sol_ecm",    biz:"Solebury Capital",                    bizSub:"ECM Advisory — PNC Subsidiary",    product:"IPO / Equity Follow-On Pipeline",  badge:"● Active Channel",                badgeCls:"badge-o",strategy:"IPO pipeline & equity follow-on transaction deal flow",                    stage:0,notes:"300+ transactions — most active ECM advisory in North America"},
  {id:"mez_main",   biz:"PNC Mezzanine Capital",               bizSub:"PNC Erieview & Riverarch Equity",  product:"Mezzanine Co-Investment",          badge:"● Active · $10–60M",              badgeCls:"badge-o",strategy:"Co-invest alongside mezzanine & junior capital — sponsor & non-sponsor",  stage:0,notes:""},
  {id:"fig_main",   biz:"PNC FIG Advisory",                    bizSub:"Financial Institutions Group",     product:"Private Placement / Capital Raise",badge:"● Active Channel",                badgeCls:"badge-o",strategy:"Capital raises & private placements via PNC FIG coverage network",          stage:0,notes:""},
];

// ── STAGE CONFIG ──────────────────────────────────────────────────────────────
const SC=['#cdd5de','#8fa8c0','#5a82a0','#c9a84c','#2e6b4f','#1a2b4a'];
const SD=['Not Yet Engaged','First Contact / Intro','Active Dialogue','Proposal / Term Sheet','Approved / Pilot','Strategic Partner'];
const N=6,VW=520,VH=56,TY=20,TH=14,TR=7;
const ZW=VW/N;
const PLACEHOLDER='Add notes…';
let UID=1000;
let openPickerId=null;

function zx(i){return i*ZW;}
function zcx(i){return zx(i)+ZW/2;}

// ── SKATER SVG ────────────────────────────────────────────────────────────────
function skater(px,py,color){
  const s=1.7,p=[];
  p.push(`<ellipse cx="${px+1}" cy="${py+6*s}" rx="${8*s}" ry="${2*s}" fill="rgba(0,0,0,0.10)"/>`);
  p.push(`<line x1="${px-6*s}" y1="${py+5.5*s}" x2="${px+8.5*s}" y2="${py+5.5*s}" stroke="${color}" stroke-width="2" stroke-linecap="round" opacity="0.95"/>`);
  p.push(`<line x1="${px}" y1="${py+0.5*s}" x2="${px-5*s}" y2="${py+5.5*s}" stroke="${color}" stroke-width="2.6" stroke-linecap="round"/>`);
  p.push(`<line x1="${px}" y1="${py+0.5*s}" x2="${px+4*s}" y2="${py+5.5*s}" stroke="${color}" stroke-width="2.6" stroke-linecap="round"/>`);
  p.push(`<line x1="${px+2*s}" y1="${py-7.5*s}" x2="${px}" y2="${py+0.5*s}" stroke="${color}" stroke-width="3" stroke-linecap="round"/>`);
  p.push(`<circle cx="${px+3*s}" cy="${py-10.5*s}" r="${3.2*s}" fill="${color}"/>`);
  p.push(`<circle cx="${px+3*s}" cy="${py-10.5*s}" r="${3.2*s}" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.2"/>`);
  p.push(`<path d="M${px+0.5*s},${py-13*s} Q${px+3*s},${py-15*s} ${px+5.5*s},${py-12.5*s}" stroke="#c9a84c" stroke-width="1.6" fill="none" stroke-linecap="round"/>`);
  p.push(`<line x1="${px+1.5*s}" y1="${py-5*s}" x2="${px-5*s}" y2="${py-2.5*s}" stroke="${color}" stroke-width="2.2" stroke-linecap="round"/>`);
  p.push(`<line x1="${px+1.5*s}" y1="${py-5*s}" x2="${px+8*s}" y2="${py-3*s}" stroke="${color}" stroke-width="2.2" stroke-linecap="round"/>`);
  const lx=px-6*s;
  p.push(`<line x1="${lx-14}" y1="${py-1}" x2="${lx}" y2="${py-1}" stroke="${color}" stroke-width="1.4" stroke-linecap="round" opacity="0.55"/>`);
  p.push(`<line x1="${lx-10}" y1="${py+3}" x2="${lx}" y2="${py+3}" stroke="${color}" stroke-width="1" stroke-linecap="round" opacity="0.35"/>`);
  p.push(`<line x1="${lx-7}" y1="${py+7}" x2="${lx}" y2="${py+7}" stroke="${color}" stroke-width="0.8" stroke-linecap="round" opacity="0.25"/>`);
  return p.join('');
}

function buildTrack(stage){
  const color=SC[stage],o=[];
  o.push(`<rect x="0" y="${TY}" width="${VW}" height="${TH}" rx="${TR}" fill="#e0dbd2"/>`);
  if(stage>0) o.push(`<rect x="0" y="${TY}" width="${zx(stage)}" height="${TH}" rx="${TR}" fill="#c4ccd6" opacity="0.6"/>`);
  const ax=zx(stage),isF=stage===0,isL=stage===N-1;
  o.push(`<rect x="${ax}" y="${TY}" width="${ZW}" height="${TH}" rx="${isF||isL?TR:3}" fill="${color}"/>`);
  o.push(`<rect x="${ax}" y="${TY}" width="${ZW}" height="4" rx="${isF?TR:2}" fill="rgba(255,255,255,0.22)"/>`);
  for(let i=1;i<N;i++){
    const dx=zx(i)-1.5;
    o.push(`<line x1="${dx}" y1="${TY+2}" x2="${dx}" y2="${TY+TH-2}" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>`);
  }
  for(let i=0;i<N;i++){
    const lx=zcx(i),isActive=i===stage;
    o.push(`<text x="${lx}" y="${VH-2}" text-anchor="middle" fill="${isActive?color:'#b0bbc8'}" font-family="Inter,sans-serif" font-size="8.5" font-weight="${isActive?'700':'400'}" letter-spacing="0.3">S${i}</text>`);
  }
  if(isL) o.push(`<line x1="${VW-4}" y1="${TY-2}" x2="${VW-4}" y2="${TY+TH+2}" stroke="${color}" stroke-width="1.8" stroke-dasharray="3,2" opacity="0.6"/>`);
  o.push(skater(zcx(stage),TY-2,color));
  return o.join('');
}

// ── INLINE PICKER HTML ────────────────────────────────────────────────────────
function buildPicker(id,stage){
  const opts=SC.map((c,i)=>`<div class="stage-opt${i===stage?' active':''}" data-stage="${i}" data-rowid="${id}"><span class="stage-num" style="color:${c}">${i}</span><span class="stage-lbl">${SD[i]}</span></div>`).join('');
  return `<div class="inline-picker" id="picker-${id}">
    <div class="picker-header">
      <span class="picker-label">Select Stage</span>
      <button class="picker-close-btn" data-closeid="${id}">✕</button>
    </div>
    <div class="stage-opts">${opts}</div>
  </div>`;
}

// ── RENDER ────────────────────────────────────────────────────────────────────
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function renderRow(row){
  const isLive=row.stage>=3;
  return `<tr class="${isLive?'live-row':''}" id="tr-${row.id}">
    <td class="col-biz">
      <input class="edit-field" data-id="${row.id}" data-f="biz" value="${esc(row.biz)}" spellcheck="false" placeholder="Business Line">
      <input class="edit-field sub" data-id="${row.id}" data-f="bizSub" value="${esc(row.bizSub)}" spellcheck="false" placeholder="Sub-line">
    </td>
    <td class="col-prod">
      <input class="edit-field" data-id="${row.id}" data-f="product" value="${esc(row.product)}" spellcheck="false" placeholder="Product name">
      <input class="edit-field badge ${esc(row.badgeCls)}" data-id="${row.id}" data-f="badge" value="${esc(row.badge)}" spellcheck="false" placeholder="Badge">
    </td>
    <td class="col-strat">
      <input class="edit-field strat" data-id="${row.id}" data-f="strategy" value="${esc(row.strategy)}" spellcheck="false" placeholder="Strategy / LOB">
    </td>
    <td class="col-track">
      <div class="track-wrap">
        <svg class="track-svg" id="svg-${row.id}" viewBox="0 0 520 56" preserveAspectRatio="none" data-id="${row.id}"></svg>
      </div>
      ${buildPicker(row.id,row.stage)}
    </td>
    <td class="col-notes">
      <textarea class="notes-edit${row.notes?'':' ph'}" data-id="${row.id}" data-f="notes" rows="1">${row.notes||PLACEHOLDER}</textarea>
    </td>
    <td class="col-actions">
      <button class="del-btn" data-delid="${row.id}" title="Remove row">✕</button>
    </td>
  </tr>`;
}

function renderAll(){
  document.getElementById('tbody-dollars').innerHTML=ROWS_DOLLARS.map(renderRow).join('');
  document.getElementById('tbody-deals').innerHTML=ROWS_DEALS.map(renderRow).join('');
  allRows().forEach(r=>{
    const el=document.getElementById('svg-'+r.id);
    if(el) el.innerHTML=buildTrack(r.stage);
  });
  initNotes();
}

// ── HELPERS ───────────────────────────────────────────────────────────────────
function allRows(){return[...ROWS_DOLLARS,...ROWS_DEALS];}
function findRow(id){return allRows().find(r=>r.id===id);}

// ── PICKER LOGIC ──────────────────────────────────────────────────────────────
function openPicker(id){
  if(openPickerId && openPickerId!==id) closePicker(openPickerId);
  if(openPickerId===id){closePicker(id);return;}
  const p=document.getElementById('picker-'+id);
  if(p){p.classList.add('open');openPickerId=id;}
}
function closePicker(id){
  const p=document.getElementById('picker-'+id);
  if(p) p.classList.remove('open');
  if(openPickerId===id) openPickerId=null;
}
function setStage(id,stage){
  const r=findRow(id);if(!r)return;
  r.stage=stage;
  const svg=document.getElementById('svg-'+id);
  if(svg) svg.innerHTML=buildTrack(stage);
  const tr=document.getElementById('tr-'+id);
  if(tr) tr.classList.toggle('live-row',stage>=3);
  // Refresh picker active states without closing
  const p=document.getElementById('picker-'+id);
  if(p) p.querySelectorAll('.stage-opt').forEach((o,i)=>o.classList.toggle('active',i===stage));
  closePicker(id);
}

// ── SINGLE DELEGATED CLICK HANDLER (handles ALL interactions) ─────────────────
document.addEventListener('click',function(e){
  // 1. Close picker close button
  const closeBtn=e.target.closest('[data-closeid]');
  if(closeBtn){closePicker(closeBtn.dataset.closeid);return;}

  // 2. Stage option click
  const stageOpt=e.target.closest('.stage-opt[data-rowid]');
  if(stageOpt){setStage(stageOpt.dataset.rowid,parseInt(stageOpt.dataset.stage));return;}

  // 3. Delete row button
  const delBtn=e.target.closest('[data-delid]');
  if(delBtn){deleteRow(delBtn.dataset.delid);return;}

  // 4. Track SVG click — note: children have pointer-events:none so e.target IS the SVG
  const svg=e.target.closest('.track-svg');
  if(svg && svg.dataset.id){openPicker(svg.dataset.id);return;}

  // 5. Click outside any open picker — close it
  if(openPickerId && !e.target.closest('.col-track')){
    closePicker(openPickerId);
  }
});

// Input field sync via delegation
document.addEventListener('change',function(e){
  const el=e.target;
  if(el.matches('input.edit-field') && el.dataset.id && el.dataset.f){
    const r=findRow(el.dataset.id);
    if(r) r[el.dataset.f]=el.value;
  }
});

// ── NOTES ─────────────────────────────────────────────────────────────────────
function initNotesOn(container){
  container.querySelectorAll('.notes-edit').forEach(ta=>{
    autoResize(ta);
    ta.addEventListener('focus',()=>{if(ta.classList.contains('ph')){ta.value='';ta.classList.remove('ph');}autoResize(ta);});
    ta.addEventListener('input',()=>{const r=findRow(ta.dataset.id);if(r)r.notes=ta.value;autoResize(ta);});
    ta.addEventListener('blur',()=>{
      const val=ta.value.trim(),r=findRow(ta.dataset.id);
      if(!val){ta.value=PLACEHOLDER;ta.classList.add('ph');if(r)r.notes='';}
      else{ta.classList.remove('ph');if(r)r.notes=val;}
      autoResize(ta);
    });
  });
}
function initNotes(){
  initNotesOn(document);
}
function autoResize(ta){ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';}

// ── ADD ROW ───────────────────────────────────────────────────────────────────
function addRow(section){
  const id='row_'+(UID++);
  const row={id,biz:'New Business Line',bizSub:'Sub-line / division',product:'New Product',badge:'● Status',badgeCls:'badge-o',strategy:'Strategy description',stage:0,notes:''};
  if(section==='dollars') ROWS_DOLLARS.push(row);
  else ROWS_DEALS.push(row);

  const tbody=document.getElementById('tbody-'+section);
  const tmp=document.createElement('tbody');
  tmp.innerHTML=renderRow(row);
  const tr=tmp.querySelector('tr');
  tbody.appendChild(tr);

  const svg=document.getElementById('svg-'+id);
  if(svg) svg.innerHTML=buildTrack(0);

  initNotesOn(tr);
  tr.scrollIntoView({behavior:'smooth',block:'center'});
  const first=tr.querySelector('input.edit-field');
  if(first) first.select();
}

// ── DELETE ROW ────────────────────────────────────────────────────────────────
function deleteRow(id){
  if(!confirm('Remove this row?'))return;
  ROWS_DOLLARS=ROWS_DOLLARS.filter(r=>r.id!==id);
  ROWS_DEALS=ROWS_DEALS.filter(r=>r.id!==id);
  const tr=document.getElementById('tr-'+id);
  if(tr)tr.remove();
}

// ── SYNC & SAVE ───────────────────────────────────────────────────────────────
function syncFromDOM(){
  document.querySelectorAll('input.edit-field').forEach(inp=>{
    if(!inp.dataset.id||!inp.dataset.f)return;
    const r=findRow(inp.dataset.id);if(r)r[inp.dataset.f]=inp.value;
  });
  document.querySelectorAll('.notes-edit').forEach(ta=>{
    if(!ta.dataset.id)return;
    const r=findRow(ta.dataset.id);
    if(r)r.notes=ta.classList.contains('ph')?'':ta.value.trim();
  });
}

function saveFile(){
  syncFromDOM();
  if(openPickerId)closePicker(openPickerId);

  const J=v=>JSON.stringify(v);
  const ser=rows=>rows.map(r=>`  {id:${J(r.id)},biz:${J(r.biz)},bizSub:${J(r.bizSub)},product:${J(r.product)},badge:${J(r.badge)},badgeCls:${J(r.badgeCls)},strategy:${J(r.strategy)},stage:${r.stage},notes:${J(r.notes)}}`).join(',\n');

  const d0=`let ROWS_DOLLARS = [\n${ser(ROWS_DOLLARS)},\n];`;
  const d1=`let ROWS_DEALS = [\n${ser(ROWS_DEALS)},\n];`;

  let html=document.documentElement.outerHTML;
  html=html.replace(/let ROWS_DOLLARS = \[[\s\S]*?\];/,d0);
  html=html.replace(/let ROWS_DEALS = \[[\s\S]*?\];/,d1);

  // data: URI works inside iframes & Notion embeds (blob URLs do not)
  const uri='data:text/html;charset=utf-8,'+encodeURIComponent('<!DOCTYPE html>\n'+html);
  const a=document.createElement('a');
  a.href=uri;a.download='pnc-callan-stage-map-editable.html';
  document.body.appendChild(a);a.click();document.body.removeChild(a);

  const btns=[document.getElementById('saveBtnTop'),document.getElementById('saveBtnBar')];
  btns.forEach(b=>{b.classList.add('saved');b.textContent='✓  Saved!';});
  setTimeout(()=>btns.forEach(b=>{
    b.classList.remove('saved');
    b.innerHTML='<svg width="13" height="13" viewBox="0 0 16 16" fill="none"><path d="M2 2h9l3 3v9a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1z" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="9" width="8" height="5" rx="0.5" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="2" width="5" height="3" rx="0.5" stroke="currentColor" stroke-width="1.5"/></svg> Save &amp; Download';
  }),2500);
}

renderAll();
</script>
</body></html>
